#!/usr/bin/env bash
# Copyright (C) 2023-2025 Fraunhofer ITWM
# License: https://raw.githubusercontent.com/cc-hpc-itwm/mcs/main/LICENSE


set -euo pipefail

TESTING_BASH_DIRECTORY="@TESTING_BASH_DIRECTORY@"

MCS_TEST_SHARE_SERVICE_BIN_PROVIDER="@MCS_TEST_SHARE_SERVICE_BIN_PROVIDER@"
MCS_TEST_SHARE_SERVICE_BIN_CREATE="@MCS_TEST_SHARE_SERVICE_BIN_CREATE@"
MCS_TEST_SHARE_SERVICE_BIN_REMOVE="@MCS_TEST_SHARE_SERVICE_BIN_REMOVE@"
MCS_TEST_SHARE_SERVICE_BIN_CAT="@MCS_TEST_SHARE_SERVICE_BIN_CAT@"
MCS_TEST_SHARE_SERVICE_BIN_WRITE="@MCS_TEST_SHARE_SERVICE_BIN_WRITE@"
MCS_TEST_SHARE_SERVICE_TESTCASE_DIRECTORY="@MCS_TEST_SHARE_SERVICE_TESTCASE_DIRECTORY@"

MCS_TEST_SHARE_SERVICE_TESTCASE=${1:?}

source "${TESTING_BASH_DIRECTORY}/cleanup"
source "${TESTING_BASH_DIRECTORY}/TMP_DIRECTORY"

MCS_TEST_SHARE_SERVICE_UNIQUE_ID="$(hostname).$$"

protocol=0

for MCS_TEST_SHARE_SERVICE_PROTOCOL in                  \
    "ip::tcp()"                                         \
    "local::stream_protocol(\"${TMP_DIRECTORY}/SOCK\")"
do
  MCS_TEST_SHARE_SERVICE_PATH="${TMP_DIRECTORY}/mcs_service_test-${protocol}.${MCS_TEST_SHARE_SERVICE_UNIQUE_ID}"
  protocol=$((protocol+1))

  "${MCS_TEST_SHARE_SERVICE_BIN_PROVIDER}"             \
      "${MCS_TEST_SHARE_SERVICE_PROTOCOL}"             \
      "${MCS_TEST_SHARE_SERVICE_PATH}"                 \
      "ScopedRunningIOContext::NumberOfThreads 1" &

  DAEMON_PATH="${MCS_TEST_SHARE_SERVICE_PATH}"
  source "${TESTING_BASH_DIRECTORY}/daemonize"

  MCS_TEST_SHARE_SERVICE_TESTCASE_OUTPUT="${TMP_DIRECTORY}/${MCS_TEST_SHARE_SERVICE_TESTCASE}.${MCS_TEST_SHARE_SERVICE_UNIQUE_ID}.out"
  MCS_TEST_SHARE_SERVICE_TEST_SHMEM_PREFIX="test.generic.${MCS_TEST_SHARE_SERVICE_UNIQUE_ID}"

  source "${MCS_TEST_SHARE_SERVICE_TESTCASE_DIRECTORY}/${MCS_TEST_SHARE_SERVICE_TESTCASE}/commands" &> "${MCS_TEST_SHARE_SERVICE_TESTCASE_OUTPUT}"

  diff "${MCS_TEST_SHARE_SERVICE_TESTCASE_DIRECTORY}/${MCS_TEST_SHARE_SERVICE_TESTCASE}/expected_output" "${MCS_TEST_SHARE_SERVICE_TESTCASE_OUTPUT}"
done
